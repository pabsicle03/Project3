<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sharetea Start Page</title>
  <link rel="stylesheet" href="startstyle.css">
  <script src="custscript.js" defer></script>

  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      width: 320px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .modal-content h2 {
      margin-bottom: 15px;
    }

    .modal-content input {
      width: 90%;
      padding: 8px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .modal-content button {
      margin-top: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background-color: #c0392b;
      color: white;
      cursor: pointer;
    }

    .modal-content button:hover {
      background-color: #a93226;
    }

    .close-btn {
      float: right;
      font-size: 18px;
      cursor: pointer;
      color: #888;
    }

    .close-btn:hover {
      color: black;
    }

    #loginError {
      color: red;
      font-size: 0.9em;
      margin-top: 8px;
      display: none;
    }

    .separator {
      margin: 15px 0;
      border-top: 1px solid #ccc;
      position: relative;
    }

    .separator span {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 0 8px;
      font-size: 0.9em;
      color: #666;
    }

    .google-login-container {
      text-align: center;
      margin-top: 15px;
    }
  </style>

  <script src="https://accounts.google.com/gsi/client" async defer></script>

</head>
<body>
  <div class="outer-container">
    <div class="inner-box">
      <div class="logo-area">
        <h1>Share<span class="red-text">tea</span></h1>
      </div>
      <div class="button-area">
        <a href="#" class="btn btn-login" id="loginBtn">Log In</a>
        <a href="#" class="btn btn-guest" id="guestBtn">Continue as Guest</a>
        <a href="#" class="btn btn-login" id="registerBtn">Register</a>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <h2>Log In</h2>

      <input type="text" id="userId" placeholder="User ID" />
      <input type="password" id="password" placeholder="Password" />
      <button id="submitLogin">Submit</button>
      <div id="loginError">Please enter both ID and password.</div>

      <div class="separator"><span>OR</span></div>

      <div class="google-login-container">
        <div id="googleLoginButton"></div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeRegister">&times;</span>
      <h2>Create Account</h2>

      <input type="text" id="regName" placeholder="Full Name" />
      <input type="text" id="regUsername" placeholder="Username" />
      <input type="password" id="regPassword" placeholder="Password" />
      <input type="email" id="regEmail" placeholder="Email" />

      <button id="submitRegister">Register</button>
      <div id="registerError" style="color:red;font-size:0.9em;margin-top:8px;display:none;"></div>
    </div>
  </div>


  <script>
    const loginBtn = document.getElementById('loginBtn');
    const guestBtn = document.getElementById('guestBtn');
    const modal = document.getElementById('loginModal');
    const closeModal = document.getElementById('closeModal');
    const submitLogin = document.getElementById('submitLogin');
    const loginError = document.getElementById('loginError');
    const registerBtn = document.getElementById('registerBtn');
    const registerModal = document.getElementById('registerModal');
    const closeRegister = document.getElementById('closeRegister');
    const submitRegister = document.getElementById('submitRegister');
    const registerError = document.getElementById('registerError');

    // Guest login → customer (NO customerName/customerEmail)
    guestBtn.addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.setItem('userId', 0);
      localStorage.removeItem('customerName');
      localStorage.removeItem('customerEmail');
      window.location.href = '/Customer/customerallmenu.html';
    });

    // Show login modal
    loginBtn.addEventListener('click', (e) => {
      e.preventDefault();
      modal.style.display = 'block';
      loginError.style.display = 'none';
    });

    // Close login modal
    closeModal.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

    // Show register modal
    registerBtn.addEventListener('click', (e) => {
      e.preventDefault();
      registerModal.style.display = 'block';
      registerError.style.display = 'none';
    });

    // Close register modal
    closeRegister.addEventListener('click', () => registerModal.style.display = 'none');
    window.addEventListener('click', (e) => {
      if (e.target === registerModal) registerModal.style.display = 'none';
    });

    // Register new customer
    submitRegister.addEventListener('click', async () => {
      const name = document.getElementById('regName').value.trim();
      const username = document.getElementById('regUsername').value.trim();
      const password = document.getElementById('regPassword').value;
      const email = document.getElementById('regEmail').value.trim();

      if (!name || !username || !password || !email) {
        registerError.textContent = "Please fill out all fields.";
        registerError.style.display = 'block';
        return;
      }

      try {
        const resp = await fetch("/api/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, username, password, email })
        });

        const data = await resp.json();

        if (!data.ok) {
          registerError.textContent = data.error || "Registration failed.";
          registerError.style.display = 'block';
          return;
        }

        // Auto-log them in as customer
        localStorage.setItem("userId", data.customerId);
        localStorage.setItem("customerName", name);
        localStorage.setItem("customerEmail", email);

        registerModal.style.display = 'none';
        window.location.href = "/Customer/customerallmenu.html";
      } catch (err) {
        console.error(err);
        registerError.textContent = "Server error. Please try again.";
        registerError.style.display = 'block';
      }
    });

    // Manual login - FIXED: Only remove customerName/Email for non-customer roles
    submitLogin.addEventListener('click', async () => {
      const id = document.getElementById('userId').value.trim();
      const password = document.getElementById('password').value;

      const resp = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, password })
      });

      const data = await resp.json();

      if (!data.ok) {
        loginError.textContent = data.message || "Invalid login.";
        loginError.style.display = 'block';
        return;
      }

      modal.style.display = 'none';

      if (data.role === "manager") {
        // Clear customer data for manager login
        localStorage.removeItem("customerName");
        localStorage.removeItem("customerEmail");
        localStorage.setItem("userId", "manager");
        window.location.href = "/Manager/orderingtrends.html";

      } else if (data.role === "cashier") {
        // Clear customer data for cashier login
        localStorage.removeItem("customerName");
        localStorage.removeItem("customerEmail");
        localStorage.setItem("userId", data.employeeId);
        window.location.href = "/Cashier/cashierall.html";

      } else if (data.role === "customer") {
        // Keep customer data for customer login - this is the fix!
        localStorage.setItem("userId", data.customerId);
        localStorage.setItem("customerName", data.customerName);
        localStorage.setItem("customerEmail", data.customerEmail);
        window.location.href = "/Customer/customerallmenu.html";

      } else {
        // Fallback: clear customer data
        localStorage.removeItem("customerName");
        localStorage.removeItem("customerEmail");
        window.location.href = "/Customer/customerallmenu.html";
      }
    });

    // Google Login → ALWAYS CUSTOMER
    function handleCredentialResponse(response) {
      const token = response.credential;
      localStorage.setItem('googleToken', token);
      
      // Decode JWT token to get user info
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        
        const userData = JSON.parse(jsonPayload);
        
        // Set customer name and email from Google account
        localStorage.setItem('customerName', userData.name || userData.email);
        localStorage.setItem('customerEmail', userData.email);
        
        console.log('Google login successful:', userData.name, userData.email);
      } catch (err) {
        console.error('Failed to decode Google token:', err);
      }
      
      modal.style.display = 'none';
      window.location.href = '/Customer/customerallmenu.html';
    }

    window.onload = function () {
      if (typeof clearAccessibilityPrefs === 'function') {
        clearAccessibilityPrefs();
      }

      // default language + fresh cart
      localStorage.setItem('language', 'en');
      localStorage.removeItem("cart");

      sessionStorage.removeItem("cashierCart");

      google.accounts.id.initialize({
        client_id: '834334576099-koeo9claok53pvmlqm6q2adfvklme2co.apps.googleusercontent.com',
        callback: handleCredentialResponse
      });

      google.accounts.id.renderButton(
        document.getElementById('googleLoginButton'),
        { theme: 'outline', size: 'large', width: '250', text: 'signin_with' }
      );
    }
  </script>
</body>
</html>